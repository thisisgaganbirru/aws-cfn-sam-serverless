AWSTemplateFormatVersion: "2010-09-09"
Description: Enterprise-Hardened IAM Roles for Serverless CI/CD Platform

Parameters:
  ArtifactBucketName:
    Type: String
    Description: S3 bucket for CodePipeline/CodeBuild artifacts

  EnvironmentName:
    Type: String
    Default: dev
    Description: Environment identifier (dev/stage/prod)

Resources:
  # =======================================================
  # 1. Lambda Execution Role (Least Privilege)
  # =======================================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub serverless-lambda-exec-${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

      Policies:
        - PolicyName: LambdaVpcAndS3ScopedAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Required for VPC-enabled Lambdas
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:AssignPrivateIpAddresses
                  - ec2:UnassignPrivateIpAddresses
                Resource: "*"

              # Allow Lambda read access to artifact bucket
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub arn:aws:s3:::${ArtifactBucketName}/*

      Tags:
        - Key: Application
          Value: ServerlessPlatform
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: DevOpsTeam

  # =======================================================
  # 2. CodeBuild Role (Scoped Build Surface)
  # =======================================================
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub serverless-codebuild-${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole

      Policies:
        - PolicyName: CodeBuildRestrictedPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Access to artifact bucket (narrow scope)
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:GetBucketLocation
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactBucketName}
                  - !Sub arn:aws:s3:::${ArtifactBucketName}/*

              # Build logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"

              # SAM template validation only â€” NO deployment
              - Effect: Allow
                Action:
                  - cloudformation:ValidateTemplate
                Resource: "*"

      Tags:
        - Key: Application
          Value: ServerlessPlatform
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: DevOpsTeam

  # =======================================================
  # 3. CodePipeline Role (Orchestration Only)
  # =======================================================
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub serverless-codepipeline-${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole

      Policies:
        - PolicyName: CodePipelineOrchestration
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Trigger CodeBuild only (no privileged actions)
              - Effect: Allow
                Action:
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuilds
                Resource: "*"

              # Access artifact bucket
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactBucketName}
                  - !Sub arn:aws:s3:::${ArtifactBucketName}/*

              # CloudFormation deploy permissions
              - Effect: Allow
                Action:
                  - cloudformation:CreateStack
                  - cloudformation:UpdateStack
                  - cloudformation:DescribeStacks
                  - cloudformation:GetTemplateSummary
                  - cloudformation:ValidateTemplate
                Resource: "*"

              # Strongly scoped PassRole (best practice)
              - Effect: Allow
                Action: iam:PassRole
                Resource: !GetAtt CloudFormationDeploymentRole.Arn

      Tags:
        - Key: Application
          Value: ServerlessPlatform
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: DevOpsTeam

  # =======================================================
  # 4. CloudFormation Deployment Role (Scoped Deployment Engine)
  # =======================================================
  CloudFormationDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub serverless-cfn-deploy-${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole

      Policies:
        - PolicyName: CFNDeploymentLeastPrivilege
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Lambda Deployment
              - Effect: Allow
                Action:
                  - lambda:CreateFunction
                  - lambda:UpdateFunctionCode
                  - lambda:UpdateFunctionConfiguration
                  - lambda:GetFunction
                  - lambda:TagResource
                Resource: "*"

              # API Gateway (scoped)
              - Effect: Allow
                Action:
                  - apigateway:GET
                  - apigateway:POST
                  - apigateway:PATCH
                  - apigateway:PUT
                  - apigateway:DELETE
                Resource: "*"

              # S3 for SAM packaging
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactBucketName}/*
                  - !Sub arn:aws:s3:::${ArtifactBucketName}

              # CloudWatch logs for Lambda
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*

      Tags:
        - Key: Application
          Value: ServerlessPlatform
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: DevOpsTeam

  # =======================================================
  # 5. Destroy Pipeline Role (Teardown)
  # =======================================================
  DestroyCodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub serverless-destroy-pipeline-${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DestroyPipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuilds
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:ListBucket
                  - s3:ListBucketVersions
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactBucketName}
                  - !Sub arn:aws:s3:::${ArtifactBucketName}/*
      Tags:
        - Key: Application
          Value: ServerlessPlatform
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: DevOpsTeam

  # =======================================================
  # 6. Destroy CodeBuild Role (Teardown)
  # =======================================================
  DestroyCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub serverless-destroy-codebuild-${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DestroyBuildPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:ListStacks
                  - cloudformation:ListStackResources
                  - cloudformation:DescribeStackEvents
                  - cloudformation:DescribeStackResource
                  - cloudformation:DescribeStackResources
                  - cloudformation:GetTemplateSummary
                  - cloudformation:GetTemplate
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ListChangeSets
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:DeleteChangeSet
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetObject
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactBucketName}
                  - !Sub arn:aws:s3:::${ArtifactBucketName}/*
      Tags:
        - Key: Application
          Value: ServerlessPlatform
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: DevOpsTeam

Outputs:
  LambdaExecutionRoleArn:
    Value: !GetAtt LambdaExecutionRole.Arn

  CodeBuildRoleArn:
    Value: !GetAtt CodeBuildRole.Arn

  CodePipelineRoleArn:
    Value: !GetAtt CodePipelineRole.Arn

  CloudFormationDeploymentRoleArn:
    Value: !GetAtt CloudFormationDeploymentRole.Arn

  DestroyCodePipelineRoleArn:
    Value: !GetAtt DestroyCodePipelineRole.Arn

  DestroyCodeBuildRoleArn:
    Value: !GetAtt DestroyCodeBuildRole.Arn
